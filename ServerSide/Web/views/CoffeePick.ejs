<div class="bgimage" >
	<% include header %>
		<% include navbar %>
		<div class="container-fluid" style="margin-top:70px;">
			<div class="row" >
				<div class="col-12">
					<div class="card mb-5 " style="min-height:100px;">
						<h1 class="card-title text-center" style="font-size: 64px; margin: auto;"><b>挑取咖啡豆服務</b></h1>
					</div>
					<div class='row'>
							<div class="col-4 text-center" >

								<h3 class="card" style="font-size: 40px; "><b>監視相機</b></h3>
								<div class = "text-center" style="max-height:80%;max-width:80%;margin:auto;">
										<img class="ms-auto d-block" style="max-height:100%;max-width:100%;" src="http://140.137.132.172:2003/?action=stream"  alt="串流2">
								</div>

								<h3 class="card mt-3" style="font-size: 40px; "><b>檢測用相機之串流影像</b></h3>
								<div class="text-center" style="max-height:80%;max-width:80%;margin: auto;">
									<img class="ms-auto d-block" style="max-height:100%;max-width:100%;" src="http://140.137.132.172:2004/arm_stream" alt="串流">								
								</div>
							</div>	
							   
							<div class="col-8">
								<div class = "card p-3 " style="min-height: 80%;">
									<div class="row">
										<div class="col-5 h-100 text-center">
											<h2 style="font-size: 42px;">檢測結果</h2>
											<img id='detected' src="./img/coffeetemp.jpg" style="margin: auto;width: 80%;" alt="dectresult">
										</div>
										<div class="col-7 h-100">
											<table class="table">
												<thead>
													<tr>
														<th scope="col">#</th>
														<th scope="col">x軸（中心點）</th>
														<th scope="col">y軸（中心點）</th>
														<th scope="col">高</th>
														<th scope="col">寬</th>
														<th scope="col">類別</th>
													</tr>
												</thead>
												<tbody id='BeanList'>
												</tbody>
											</table>
										</div>
									</div>
								</div>
		
								<div class = "offset-8 mt-2">
									<div class="row" >
										<div class="btn-group text-center mr-3" role="group">
											<button style="font-size: 32px;" id="detect" type="button"  class="btn btn-primary h-100">檢測生豆</button>
										</div>	
										<div class="btn-group text-center" role="group">
											<button style="font-size: 32px;" id="pick" type="button"  class="btn btn-primary h-100">開始抓取</button>
										</div>											  
									</div>
									
								</div>
							</div>	
					</div>
					</div>	
				</div>		
			</div>
		</div>
		<script>
			$('document').ready(function(){
				//已經檢測過豆子
				var already = false;
				var curbeans = [];
				$('#pick').click(function(){
					if(!already){
						alert('尚未對生豆進行瑕疵檢測')
					}
					var defectBean = curbeans.filter(x =>x.c != 0)
					
					$.ajax({
						type:'post',
						url:'./api/pick_bean',
						data : {'defectBean' : defectBean},
						success: function(res){
							console.log('c')
						}
					})

				})

				$('#detect').click(function(){
					already = true

					$.ajax({
						type:'get',
						url:'./api/detectBean',
						success: function(res){
								curbeans = res.data
								var resultImg = res.ResultImage
								var img = res.ImageName
								//顯示包含bounding box之影像
								url = "data:image/jpg;base64," + resultImg
								$('#detected').attr('src',url)
								
								var defect = 0

								//BEAN LIST
								var BeanList = $('#BeanList')
								var index = 1;
								console.log(curbeans)
								curbeans.forEach(function(item,index){
									if(this.c != 0){
										defect+=1
									}
									var x = Number(item.x).toFixed(2)
									var y = Number(item.y).toFixed(2)
									var h = Number(item.h).toFixed(2)
									var w = Number(item.w).toFixed(2)
									var c = Number(item.c).toFixed(2)
									console.log(item)
									var indextd = $('<td>').text(index.toString())
									var xtd = $('<td>').text(Math.abs(x) + w/2).attr('id','x_value')
									var ytd = $('<td>').text(Math.abs(y) + h/2).attr('id','y_value')
    								var heightd = $('<td>').text(Math.abs(h)).attr('id','h_value')
									var widthtd = $('<td>').text(Math.abs(w)).attr('id','w_value')
									var ctd = $('<td>').text(c).attr('id','c_value')
									var curBeanData = $('<tr>').append(indextd).append(xtd).append(ytd).append(heightd).append(widthtd).append(ctd)
									BeanList.append(curBeanData)
									index++;
								})
								var defectRate = defect/curbeans.length;
								//store record
								$.ajax({
									type: 'post',
									url:'./api/StoreRecord',
									data : {
										'image' : img ,
										'defectRate': defectRate,
										'Data' : curbeans,
										'Date' : Date.now()
									},
									success : function(data){
										console.log('stored')
									},
									error : function(){
										console.log(this.data)
									}
									
								})
							}
					});
				})
			});
		</script>
	<% include footer %>
</div>